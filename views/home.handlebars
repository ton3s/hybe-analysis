<!DOCTYPE html>
<html>
<head>
    <title>HYBE - Trial {{trialNumber}}</title>
	<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <h1 class="main-title">HYBE Analysis</h1>
    <form action="/" method="GET">
		<select name="trial" onchange="this.form.submit()">
			{{#each trialNumbers}}
			<option value="{{this}}" {{#if (eq ../trialNumber this)}}selected{{/if}}>Trial {{this}}</option>
			{{/each}}
		</select>
	</form>
    <div class="container">
        <div class="timestamp">
			<p>Created At: {{data.created_at}}</p>
			<p>Updated At: {{data.updated_at}}</p>
		</div>
        {{#each data.content}}
            <div class="content-section">
                <h3>Role: {{this.role}}</h3>
                <pre>{{this.content}}</pre>
				<button class="button-glow" onclick="explainInLaymansTerms({{@index}})">Explain This</button>
            </div>
        {{/each}}
		<!-- Notification Box (initially hidden) -->
		<div id="notification-box" style="display: none;">
			<div class="notification-content">
				<span class="close-btn" onclick="closeNotification()">&times;</span>
				<p id="chat-response"></p>
			</div>
		</div>
		<script>
			function explainInLaymansTerms(index) {
				// Targeting 'pre' instead of 'p' inside '.content-section'
				const content = document.querySelectorAll('.content-section pre')[index].textContent;
				console.log('Content:', content);
				fetch('/explain', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ text: content })
				})
				.then(response => response.json())
				.then(data => {
					console.log('Explanation:', data.explanation);
					showNotification(data.explanation)
				})
				.catch(error => console.error('Error explaining content:', error));
			}

			function showNotification(markdownMessage) {
				const htmlContent = marked.parse(markdownMessage); // Convert Markdown to HTML
				document.getElementById('chat-response').innerHTML = htmlContent; // Use innerHTML to render HTML content
				document.getElementById('notification-box').style.display = 'flex';
			}

			function closeNotification() {
				document.getElementById('notification-box').style.display = 'none'
			}
		</script>
    </div>
</body>
</html>
